version: 2.1

orbs:
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout

      - run:
          name: Install Backend Dependencies
          command: |
            cd udagram/udagram-api
            npm install

      - run:
          name: Install Frontend Dependencies
          command: |
            cd udagram/udagram-frontend
            npm install --legacy-peer-deps

      - run:
          name: Build Backend
          command: |
            cd udagram/udagram-api
            npm run build

      - run:
          name: Build Frontend
          command: |
            cd udagram/udagram-frontend
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run build

  deploy:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout

      - run:
          name: Install AWS CLI
          command: |
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install

      - run:
          name: Configure AWS Credentials
          command: |
            mkdir -p ~/.aws
            cat > ~/.aws/credentials \<< EOF
            [default]
            aws_access_key_id = ${AWS_ACCESS_KEY_ID}
            aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
            aws_session_token = ${AWS_SESSION_TOKEN}
            EOF
            cat > ~/.aws/config \<< EOF
            [default]
            region = ${AWS_DEFAULT_REGION:-us-east-1}
            output = json
            EOF

      - run:
          name: Install EB CLI
          command: |
            sudo apt-get update && sudo apt-get install -y python3-pip zip
            pip3 install awsebcli --upgrade --user
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Deploy Frontend to S3
          command: |
            cd udagram/udagram-frontend
            npm install --legacy-peer-deps
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run build
            aws s3 sync ./www s3://udagram-frontend-amribrahem-06122025/ --delete

      - run:
          name: Deploy Backend to Elastic Beanstalk
          command: |
            cd udagram/udagram-api
            npm install
            npm run build
            eb init udagram-api --platform "Node.js 20" --region us-east-1
            eb use udagram-api-dev
            eb setenv \
              POSTGRES_USERNAME="$POSTGRES_USERNAME" \
              POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
              POSTGRES_HOST="$POSTGRES_HOST" \
              POSTGRES_DB="$POSTGRES_DB" \
              AWS_BUCKET="$AWS_BUCKET" \
              AWS_REGION="$AWS_REGION" \
              JWT_SECRET="$JWT_SECRET"
            eb deploy udagram-api-dev --timeout 30

workflows:
  udagram-deployment:
    jobs:
      - build:
          filters:
            branches:
              only: master

      - hold:
          type: approval
          requires:
            - build

      - deploy:
          requires:
            - hold
