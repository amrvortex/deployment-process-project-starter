version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.1
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout

      - run:
          name: Check Directory Structure
          command: |
            echo "Current directory: $(pwd)"
            ls -la
            ls -la udagram/

      - run:
          name: Update Node.js version in package.json
          command: |
            cd udagram/udagram-api
            sed -i 's/"node": "14\.15\.0"/"node": ">=20.0.0"/' package.json
            echo "Updated package.json:"
            cat package.json | grep -A2 "engines"

      - run:
          name: Install Backend Dependencies
          command: |
            cd udagram/udagram-api
            npm install

      - run:
          name: Install Frontend Dependencies
          command: |
            cd udagram/udagram-frontend
            npm install --legacy-peer-deps

      - run:
          name: Build Backend
          command: |
            cd udagram/udagram-api
            npm run build

      - run:
          name: Build Frontend
          command: |
            cd udagram/udagram-frontend
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run build

  deploy:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout

      - aws-cli/setup

      - run:
          name: Install EB CLI
          command: |
            pip install awsebcli

      - run:
          name: Deploy Frontend to S3
          command: |
            cd udagram/udagram-frontend
            npm install --legacy-peer-deps
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run build
            
            aws s3 sync ./www s3://udagram-frontend-amribrahem-06122025/ --delete
            
            aws s3 cp ./www/index.html s3://udagram-frontend-amribrahem-06122025/index.html \
              --metadata-directive REPLACE \
              --cache-control "max-age=0,no-cache,no-store,must-revalidate"
            
            echo "Frontend deployed to S3"
            echo "URL: http://udagram-frontend-amribrahem-06122025.s3-website-us-east-1.amazonaws.com"

      - run:
          name: Verify Frontend Deployment
          command: |
            aws s3 ls s3://udagram-frontend-amribrahem-06122025/ --summarize

      - run:
          name: Deploy Backend to Elastic Beanstalk
          command: |
            cd udagram/udagram-api
            npm install
            npm run build
            
            eb init udagram-api --platform "Node.js 20" --region us-east-1
            eb use udagram-api-dev
            eb deploy udagram-api-dev --timeout 30
            
            echo "Backend deployed to Elastic Beanstalk"
            echo "API URL: http://udagram-api-dev.eba-cpkizpuh.us-east-1.elasticbeanstalk.com"

      - run:
          name: Verify Backend Deployment
          command: |
            cd udagram/udagram-api
            eb status udagram-api-dev

workflows:
  udagram-deployment:
    jobs:
      - build:
          filters:
            branches:
              only: master

      - hold:
          type: approval
          requires:
            - build

      - deploy:
          requires:
            - hold
