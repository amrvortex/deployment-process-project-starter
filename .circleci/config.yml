version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.1
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/node:20.0  # MUST match your EB: Node.js 20
    steps:
      - checkout
      
      # Update package.json Node.js version if needed (optional)
      - run:
          name: Update Node.js version in package.json
          command: |
            cd udagram-api
            # Update engines field to Node.js 20
            sed -i 's/"node": "14\.15\.0"/"node": "20.x"/' package.json
            echo "Updated package.json Node.js version to 20.x"
      
      # Install backend dependencies
      - run:
          name: Install Backend Dependencies
          command: |
            cd udagram-api
            npm install
      
      # Install frontend dependencies
      - run:
          name: Install Frontend Dependencies
          command: |
            cd udagram-frontend
            npm install
      
      # Build backend
      - run:
          name: Build Backend
          command: |
            cd udagram-api
            npm run build
      
      # Build frontend
      - run:
          name: Build Frontend
          command: |
            cd udagram-frontend
            npm run build
      
      # Verify builds
      - run:
          name: Verify Builds
          command: |
            echo "Backend build:"
            ls -la udagram-api/www/
            echo ""
            echo "Frontend build:"
            ls -la udagram-frontend/www/

  deploy:
    docker:
      - image: cimg/node:20.0  # MUST match your EB: Node.js 20
    steps:
      - checkout
      
      # Setup AWS CLI
      - aws-cli/setup
      
      # Update Node.js version in package.json for deployment
      - run:
          name: Ensure Node.js 20 in package.json
          command: |
            cd udagram-api
            sed -i 's/"node": "14\.15\.0"/"node": "20.x"/' package.json
            cat package.json | grep -A2 "engines"
      
      # Deploy Frontend to S3
      - run:
          name: Deploy Frontend to S3
          command: |
            echo "ðŸš€ Deploying Frontend to S3..."
            cd udagram-frontend
            
            # Install and build
            npm install
            npm run build
            
            # Deploy to S3
            aws s3 sync ./www s3://udagram-frontend-amribrahem-06122025/ \
              --acl public-read \
              --delete \
              --cache-control "max-age=31536000"
            
            # Special cache headers for index.html
            aws s3 cp ./www/index.html s3://udagram-frontend-amribrahem-06122025/index.html \
              --metadata-directive REPLACE \
              --cache-control "max-age=0,no-cache,no-store,must-revalidate" \
              --acl public-read
            
            echo "âœ… Frontend deployed to S3"
            echo "ðŸ”— URL: http://udagram-frontend-amribrahem-06122025.s3-website-us-east-1.amazonaws.com"
      
      # Deploy Backend to Elastic Beanstalk
      - run:
          name: Deploy Backend to Elastic Beanstalk
          command: |
            echo "ðŸš€ Deploying Backend to Elastic Beanstalk..."
            cd udagram-api
            
            # Install dependencies
            npm install
            
            # Build the application
            npm run build
            
            # Deploy using EB CLI
            # The .elasticbeanstalk/config.yml is already configured correctly
            eb deploy udagram-api-dev --verbose --timeout 30
            
            echo "âœ… Backend deployed to Elastic Beanstalk"
            echo "ðŸ”— API URL: http://udagram-api-dev.eba-cpkizpuh.us-east-1.elasticbeanstalk.com"
      
      # Verify deployments
      - run:
          name: Verify All Deployments
          command: |
            echo "=== ðŸ“‹ Deployment Verification ==="
            echo ""
            echo "1. âœ… S3 Frontend:"
            aws s3 ls s3://udagram-frontend-amribrahem-06122025/ --recursive --human-readable | head -5
            echo ""
            echo "2. âœ… Elastic Beanstalk Status:"
            aws elasticbeanstalk describe-environments \
              --environment-names "udagram-api-dev" \
              --query "Environments[0].[EnvironmentName, Status, Health, VersionLabel]" \
              --output table
            echo ""
            echo "3. âœ… API Test:"
            curl -s -f http://udagram-api-dev.eba-cpkizpuh.us-east-1.elasticbeanstalk.com/api/v0/feed \
              && echo "API is working!" \
              || echo "API test failed"

workflows:
  udagram-deployment:
    jobs:
      - build
      
      - hold:
          type: approval
          requires:
            - build
          filters:
            branches:
              only: master
      
      - deploy:
          requires:
            - hold
          filters:
            branches:
              only: master