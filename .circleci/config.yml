version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.1
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      
      # First, check directory structure
      - run:
          name: Check Directory Structure
          command: |
            echo "Current directory: $(pwd)"
            ls -la
            echo "---"
            find . -type d -name "*api*" -o -name "*frontend*" | head -10
      
      # Update package.json Node.js version (WITH CORRECT PATH)
      - run:
          name: Update Node.js version in package.json
          command: |
            # Check if we need to cd into udagram-api or if we're already there
            if [ -f "package.json" ]; then
              echo "Already in udagram-api directory"
              # Update engines field to Node.js 20
              sed -i 's/"node": "14\.15\.0"/"node": ">=20.0.0"/' package.json
            elif [ -d "udagram-api" ]; then
              echo "Changing to udagram-api directory"
              cd udagram-api
              sed -i 's/"node": "14\.15\.0"/"node": ">=20.0.0"/' package.json
            elif [ -d "deployment-process-project-starter/udagram/udagram-api" ]; then
              echo "Changing to nested directory"
              cd deployment-process-project-starter/udagram/udagram-api
              sed -i 's/"node": "14\.15\.0"/"node": ">=20.0.0"/' package.json
            else
              echo "ERROR: Cannot find udagram-api directory"
              find . -name "package.json" -type f
              exit 1
            fi
            echo "Updated package.json Node.js version to >=20.0.0"
            cat package.json | grep -A2 "engines"
      
      # Install backend dependencies (WITH CORRECT PATH)
      - run:
          name: Install Backend Dependencies
          command: |
            # Find and cd to backend
            if [ -f "package.json" ] && grep -q "udagram-api" package.json; then
              echo "Already in backend directory"
            elif [ -d "udagram-api" ]; then
              cd udagram-api
            elif [ -d "deployment-process-project-starter/udagram/udagram-api" ]; then
              cd deployment-process-project-starter/udagram/udagram-api
            fi
            npm install
      
      # Install frontend dependencies (WITH CORRECT PATH)
      - run:
          name: Install Frontend Dependencies
          command: |
            # Find and cd to frontend
            if [ -d "udagram-frontend" ]; then
              cd udagram-frontend
            elif [ -d "deployment-process-project-starter/udagram/udagram-frontend" ]; then
              cd deployment-process-project-starter/udagram/udagram-frontend
            elif [ -f "src/environments/environment.prod.ts" ]; then
              echo "Already in frontend directory"
            else
              echo "ERROR: Cannot find frontend directory"
              find . -name "environment.prod.ts" -type f
              exit 1
            fi
            npm install
      
      # Build backend (WITH CORRECT PATH)
      - run:
          name: Build Backend
          command: |
            # Find and cd to backend
            if [ -f "package.json" ] && grep -q "udagram-api" package.json; then
              echo "Already in backend directory"
            elif [ -d "udagram-api" ]; then
              cd udagram-api
            elif [ -d "deployment-process-project-starter/udagram/udagram-api" ]; then
              cd deployment-process-project-starter/udagram/udagram-api
            fi
            npm run build
      
      # Build frontend (WITH CORRECT PATH)
      - run:
          name: Build Frontend
          command: |
            # Find and cd to frontend
            if [ -d "udagram-frontend" ]; then
              cd udagram-frontend
            elif [ -d "deployment-process-project-starter/udagram/udagram-frontend" ]; then
              cd deployment-process-project-starter/udagram/udagram-frontend
            elif [ -f "src/environments/environment.prod.ts" ]; then
              echo "Already in frontend directory"
            fi
            npm run build

  deploy:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      
      # Setup AWS CLI
      - aws-cli/setup
      
      # Install Elastic Beanstalk CLI
      - run:
          name: Install EB CLI
          command: |
            pip install awsebcli
      
      # Deploy Frontend to S3
      - run:
          name: Deploy Frontend to S3
          command: |
            echo "ðŸš€ Deploying Frontend to S3..."
            
            # Find frontend directory
            if [ -d "udagram-frontend" ]; then
              cd udagram-frontend
            elif [ -d "deployment-process-project-starter/udagram/udagram-frontend" ]; then
              cd deployment-process-project-starter/udagram/udagram-frontend
            fi
            
            # Install and build
            npm install
            npm run build
            
            # Deploy to S3
            aws s3 sync ./www s3://udagram-frontend-amribrahem-06122025/ \
              --acl public-read \
              --delete
            
            # Special cache headers for index.html
            aws s3 cp ./www/index.html s3://udagram-frontend-amribrahem-06122025/index.html \
              --metadata-directive REPLACE \
              --cache-control "max-age=0,no-cache,no-store,must-revalidate" \
              --acl public-read
            
            echo "âœ… Frontend deployed to S3"
            echo "ðŸ”— URL: http://udagram-frontend-amribrahem-06122025.s3-website-us-east-1.amazonaws.com"
      
      # Deploy Backend to Elastic Beanstalk
      - run:
          name: Deploy Backend to Elastic Beanstalk
          command: |
            echo "ðŸš€ Deploying Backend to Elastic Beanstalk..."
            
            # Find backend directory
            if [ -f "package.json" ] && grep -q "udagram-api" package.json; then
              echo "Already in backend directory"
            elif [ -d "udagram-api" ]; then
              cd udagram-api
            elif [ -d "deployment-process-project-starter/udagram/udagram-api" ]; then
              cd deployment-process-project-starter/udagram/udagram-api
            fi
            
            # Install dependencies
            npm install
            
            # Build the application
            npm run build
            
            # Initialize EB (use existing config)
            eb init udagram-api --platform node.js --region us-east-1 --verbose
            
            # Deploy to existing environment
            eb deploy udagram-api-dev --verbose --timeout 30
            
            echo "âœ… Backend deployed to Elastic Beanstalk"
            echo "ðŸ”— API URL: http://udagram-api-dev.eba-cpkizpuh.us-east-1.elasticbeanstalk.com"

workflows:
  udagram-deployment:
    jobs:
      - build
      
      - hold:
          type: approval
          requires:
            - build
          filters:
            branches:
              only: master
      
      - deploy:
          requires:
            - hold
          filters:
            branches:
              only: master