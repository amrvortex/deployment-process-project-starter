version: 2.1

orbs:
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout

      - run:
          name: Check Directory Structure
          command: |
            echo "Current directory: $(pwd)"
            ls -la
            ls -la udagram/

      - run:
          name: Update Node.js version in package.json
          command: |
            cd udagram/udagram-api
            sed -i 's/"node": "14\.15\.0"/"node": ">=20.0.0"/' package.json
            echo "Updated package.json:"
            cat package.json | grep -A2 "engines"

      - run:
          name: Install Backend Dependencies
          command: |
            cd udagram/udagram-api
            npm install

      - run:
          name: Install Frontend Dependencies
          command: |
            cd udagram/udagram-frontend
            npm install --legacy-peer-deps

      - run:
          name: Build Backend
          command: |
            sudo apt-get update && sudo apt-get install -y zip
            cd udagram/udagram-api
            npm run build

      - run:
          name: Build Frontend
          command: |
            cd udagram/udagram-frontend
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run build

  deploy:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout

      - run:
          name: Debug AWS Credentials
          command: |
            echo "Checking AWS environment variables..."
            echo "AWS_ACCESS_KEY_ID is set: $(if [ -n "$AWS_ACCESS_KEY_ID" ]; then echo "YES (length: ${#AWS_ACCESS_KEY_ID})"; else echo "NO"; fi)"
            echo "AWS_SECRET_ACCESS_KEY is set: $(if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then echo "YES (length: ${#AWS_SECRET_ACCESS_KEY})"; else echo "NO"; fi)"
            echo "AWS_SESSION_TOKEN is set: $(if [ -n "$AWS_SESSION_TOKEN" ]; then echo "YES (length: ${#AWS_SESSION_TOKEN})"; else echo "NO"; fi)"
            echo "AWS_DEFAULT_REGION is set: $(if [ -n "$AWS_DEFAULT_REGION" ]; then echo "YES ($AWS_DEFAULT_REGION)"; else echo "NO"; fi)"
            echo "First 4 chars of Access Key: ${AWS_ACCESS_KEY_ID:0:4}****"

      - run:
          name: Install AWS CLI
          command: |
            if ! command -v aws &> /dev/null; then
              echo "Installing AWS CLI..."
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              sudo ./aws/install
            fi
            aws --version

      - run:
          name: Configure AWS Credentials
          command: |
            mkdir -p ~/.aws
            
            if [ -n "$AWS_SESSION_TOKEN" ]; then
              echo "Configuring with session token (AWS Academy/temporary credentials)..."
              cat > ~/.aws/credentials << EOF
            [default]
            aws_access_key_id = ${AWS_ACCESS_KEY_ID}
            aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
            aws_session_token = ${AWS_SESSION_TOKEN}
            EOF
            else
              echo "Configuring with permanent credentials..."
              cat > ~/.aws/credentials << EOF
            [default]
            aws_access_key_id = ${AWS_ACCESS_KEY_ID}
            aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
            EOF
            fi
            
            cat > ~/.aws/config << EOF
            [default]
            region = ${AWS_DEFAULT_REGION:-us-east-1}
            output = json
            EOF
            
            echo "AWS CLI configured successfully"

      - run:
          name: Verify AWS Authentication
          command: |
            echo "Testing AWS connection..."
            aws sts get-caller-identity
            echo "AWS authentication successful!"

      - run:
          name: Install EB CLI
          command: |
            sudo apt-get update && sudo apt-get install -y python3-pip
            pip3 install awsebcli --upgrade --user
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            eb --version

      - run:
          name: Build and Deploy Frontend to S3
          command: |
            cd udagram/udagram-frontend
            npm install --legacy-peer-deps
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run build
            
            echo "Deploying to S3..."
            aws s3 sync ./www s3://udagram-frontend-amribrahem-06122025/ --delete
            
            echo "Setting cache control for index.html..."
            aws s3 cp ./www/index.html s3://udagram-frontend-amribrahem-06122025/index.html \
              --metadata-directive REPLACE \
              --cache-control "max-age=0,no-cache,no-store,must-revalidate"
            
            echo "Frontend deployed successfully!"
            echo "URL: http://udagram-frontend-amribrahem-06122025.s3-website-us-east-1.amazonaws.com"

      - run:
          name: Verify Frontend Deployment
          command: |
            echo "Verifying S3 deployment..."
            aws s3 ls s3://udagram-frontend-amribrahem-06122025/ --summarize

      - run:
          name: Build and Deploy Backend to Elastic Beanstalk
          command: |
            sudo apt-get update && sudo apt-get install -y zip
            cd udagram/udagram-api
            npm install
            npm run build
            
            echo "Initializing Elastic Beanstalk..."
            eb init udagram-api --platform "Node.js 20" --region us-east-1
            
            echo "Deploying to Elastic Beanstalk..."
            eb use udagram-api-dev
            eb deploy udagram-api-dev --timeout 30
            
            echo "Backend deployed successfully!"
            echo "API URL: http://udagram-api-dev.eba-cpkizpuh.us-east-1.elasticbeanstalk.com"

      - run:
          name: Verify Backend Deployment
          command: |
            cd udagram/udagram-api
            eb status udagram-api-dev

workflows:
  udagram-deployment:
    jobs:
      - build:
          filters:
            branches:
              only: master

      - hold:
          type: approval
          requires:
            - build

      - deploy:
          requires:
            - hold
